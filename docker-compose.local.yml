# =============================================================================
# Multi-Index RAG Finance - LOCAL DEVELOPMENT
# =============================================================================
# Separate from production docker-compose.yml
# Optimized for local testing with hot-reload and debug mode
#
# Usage:
#   docker-compose -f docker-compose.local.yml up
#   docker-compose -f docker-compose.local.yml down
# =============================================================================

services:
  # ==========================================================================
  # Redis Cache (Shared)
  # ==========================================================================
  redis-local:
    image: redis:7-alpine
    container_name: rag-redis-local
    ports:
      - "6379:6379"  # Exposed for local access
    volumes:
      - redis_local_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - rag-local-network

  # ==========================================================================
  # Backend API + RAG Pipeline (DEV MODE)
  # ==========================================================================
  backend-local:
    # Option 1: Use pre-built image with models cached (FAST)
    image: multi_index_rag_for_finance-backend:latest
    
    # Option 2: Build from scratch (SLOW - downloads models)
    # Uncomment to rebuild:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    
    container_name: rag-backend-local
    ports:
      - "8000:8000"  # Exposed publicly
    env_file:
      - .env
    environment:
      # Local development overrides
      - REDIS_URL=redis://redis-local:6379
      - DEBUG=True
      - LOG_LEVEL=DEBUG
      - CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
      # Disable rate limiting for testing
      - FALLBACK_RATE_LIMIT_PER_USER=999
    depends_on:
      redis-local:
        condition: service_healthy
    volumes:
      # MOUNT SOURCE CODE for hot-reload
      - ./src:/app/src:ro
      - ./test:/app/test:ro
      - ./logs:/app/logs
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    networks:
      - rag-local-network

  # ==========================================================================
  # Frontend (Next.js DEV MODE)
  # ==========================================================================
  frontend-local:
    image: node:20-slim
    container_name: rag-frontend-local
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NODE_ENV=development
    volumes:
      # MOUNT SOURCE for hot-reload
      - ./frontend:/app
      # Exclude node_modules from mount
      - /app/node_modules
    command: sh -c "npm install && npm run dev"
    restart: unless-stopped
    networks:
      - rag-local-network
    depends_on:
      - backend-local

# =============================================================================
# Networks
# =============================================================================
networks:
  rag-local-network:
    driver: bridge
    name: rag-local-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis_local_data:
    name: rag-redis-local-data
