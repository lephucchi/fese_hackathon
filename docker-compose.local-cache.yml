# =============================================================================
# Docker Compose Local - With Persistent Model Cache
# =============================================================================
# Alternative config that caches models on host to avoid re-downloading
# Use this if you want to rebuild but keep models cached
#
# Usage:
#   docker-compose -f docker-compose.local-cache.yml up
# =============================================================================

services:
  # ==========================================================================
  # Redis Cache (Shared)
  # ==========================================================================
  redis-local:
    image: redis:7-alpine
    container_name: rag-redis-local
    ports:
      - "6379:6379"
    volumes:
      - redis_local_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - rag-local-network

  # ==========================================================================
  # Backend with Persistent Model Cache
  # ==========================================================================
  backend-local:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag-backend-local
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis-local:6379
      - DEBUG=True
      - LOG_LEVEL=DEBUG
      - CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
      - FALLBACK_RATE_LIMIT_PER_USER=999
      # Cache directories
      - TRANSFORMERS_CACHE=/app/.cache/huggingface
      - HF_HOME=/app/.cache/huggingface
      - SENTENCE_TRANSFORMERS_HOME=/app/.cache/sentence-transformers
    depends_on:
      redis-local:
        condition: service_healthy
    volumes:
      # Source code (hot-reload)
      - ./src:/app/src:ro
      - ./test:/app/test:ro
      - ./logs:/app/logs
      
      # PERSISTENT MODEL CACHE (shared across rebuilds)
      - model_cache:/app/.cache
      
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    networks:
      - rag-local-network

  # ==========================================================================
  # Frontend (Next.js DEV MODE)
  # ==========================================================================
  frontend-local:
    image: node:20-slim
    container_name: rag-frontend-local
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NODE_ENV=development
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev"
    restart: unless-stopped
    networks:
      - rag-local-network
    depends_on:
      - backend-local

# =============================================================================
# Networks
# =============================================================================
networks:
  rag-local-network:
    driver: bridge
    name: rag-local-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis_local_data:
    name: rag-redis-local-data
  
  # Persistent model cache - survives container rebuilds
  model_cache:
    name: rag-model-cache
